apiVersion: batch.volcano.sh/v1alpha1
kind: Job
metadata:
  name: sc2-{{ exp_config }}
spec:
  maxRetry: 1
  minAvailable: 1
  schedulerName: volcano
  queue: default
  tasks:
    - replicas: 1
      name: train
      template:
        spec:
          restartPolicy: OnFailure
          imagePullSecrets:
            - name: dkr-creds
          securityContext:
            runAsUser: 1000
          nodeSelector:
            nvidia.com/gpu.product: {{ gpu_name }}
          containers:
            - name: runner
              image: {{ registry }}/sc2-experiments:{{ git_branch }}
              imagePullPolicy: Always
              command:
                [
                  python,
                  /app/outcome_forecast/train.py,
                  --workspace=/mnt/storage/sc2-minimap-experiments,
                  --config-file=/mnt/storage/sc2-minimap-experiments/config/{{ exp_config }}.yml,
                  --epoch={{ epochs }},
                  --workers={{ n_worker }},
                {%- if brief %}
                  --brief={{ brief }},
                {%- endif %}
                ]
              env:
                - name: DATAPATH
                  value: /mnt/storage/sc2-minimap-subset
              resources:
                requests:
                  memory: {{ mem }}Gi
                  cpu: {{ cpu }}m
                  nvidia.com/gpu: {{ n_gpu }}
                limits:
                  memory: {{ (mem * 1.5) | int }}Gi
                  cpu: {{ (cpu * 1.5) | int }}m
                  nvidia.com/gpu: {{ n_gpu }}
              volumeMounts:
                - name: storage
                  mountPath: /mnt/storage
                - name: dshm
                  mountPath: /dev/shm
          volumes:
            - name: storage
              nfs:
                server: 130.194.128.238
                path: /mnt/fast/more-users/bryce-rhys
            - name: dshm
              emptyDir:
                medium: Memory
